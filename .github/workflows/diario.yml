name: Scraper Di√°rio Rio

on:
  schedule:
    - cron: '0 11 * * *'  # 08:00 AM no Brasil (UTC-3)
  workflow_dispatch:      # Bot√£o manual

permissions:
  contents: write  # Permite criar Releases e commitar o JSON

jobs:
  scrape-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: üì¶ Instalar depend√™ncias
      run: pip install -r requirements.txt
    
    - name: üöÄ Rodar Scraper
      run: python scraper.py

    - name: üíæ Verificar se h√° novos arquivos
      id: check_files
      run: |
        if [ -d "Diarios_Rio_PDF" ] && [ "$(ls -A Diarios_Rio_PDF/*.pdf 2>/dev/null)" ]; then
          echo "has_files=true" >> $GITHUB_OUTPUT
          echo "Arquivos encontrados!"
        else
          echo "has_files=false" >> $GITHUB_OUTPUT
          echo "Nenhum PDF novo baixado."
        fi

    - name: üìù Salvar Hist√≥rico (Commit JSON)
      if: steps.check_files.outputs.has_files == 'true'
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add historico.json
        git commit -m "ü§ñ Atualiza hist√≥rico de downloads" || echo "Nada para commitar"
        git push

    - name: üì¶ Zipar PDFs
      if: steps.check_files.outputs.has_files == 'true'
      run: |
        cd Diarios_Rio_PDF
        zip -r ../diarios_rio_$(date +'%Y-%m-%d').zip *.pdf

    - name: üè∑Ô∏è Criar Release
      if: steps.check_files.outputs.has_files == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Di√°rios $(date +'%d/%m/%Y')
        files: diarios_rio_*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
